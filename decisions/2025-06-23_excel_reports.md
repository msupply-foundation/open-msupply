# Exporting Excel Reports from Open mSupply

- _Date_: 2025-06-23
- _Deciders_: @lache-melvin, @andreievg
- _Status_: TO DECIDE
- _Outcome_:

## Context

OMS Reports (and forms) are currently generated by providing an HTML template, and some data. These can then be printed (by printing the rendered HTML page) or converted to Excel.

At the time of writing, export to Excel only takes the inner data table of the report (the header row and the data rows), and renders these rows in an Excel table.

This is a great start, but fails to support more complex needs:

### Use cases

- Some clients provide existing Excel sheets to us. Ideally, we could just define where to populate this template, and the client keeps all their existing formatting and formulae.
- The HTML/printable exports include a header section with important information (e.g. the report name, period, relevant customer/supplier data...). Excel exports should also include this information.

### Considerations

- Most reports are designed with a specific kind of user in mind - some reports are really only for high level reporting (only be needed in printable HTML/PDF format) while others are intended for further extraction and reporting, where Excel would be their primary format. A solution should:
  - Allow easy configuration of either primary format, without too much consideration for the other format
  - The secondary format would ideally be supported, at least in a rudimentary manner, by default
- Excel reports may be further processed, e.g. used to generate pivot tables. We should support this by ensuring there is a blank row between any header data and the main table header row, as well as between the data rows and the `total` row, if applicable.
- In supporting 2 formats, we take on the responsibility of ensuring both formats match for every report. Bugs fixed/fields changed etc. for one format need to be applied to the other.
  - Therefore, the more that is shared by default the better, but this needs to be without creating additional overhead (we should aim to limit "oh I can't do this in HTML because it won't be supported in the Excel version")
- When viewing Excel reports, it would be helpful to see the underlying formulae, rather than just the resulting data
- We have as few OMS reports as we ever will have, so now is the right time to define if any changes need to be made to existing reports & forms to support Excel export. However, ideally we can mitigate these changes (keep support of the existing data-only Excel export, header section can be added on request at a later date).

## Options

### Option 1 - Generate Excel sheet entirely from HTML, using HTML tables

Anticipates that any formatting desired for one format would be desired for the other. HTML template must be defined using HTML tables - then the concept of columns + rows is already embedded in the template, which maps more easily to the Excel export. OMS needs to support deriving styles from the HTML template and mapping these to the cells in Excel.

_Pros:_

- Only one template to define when creating the initial report, and one place to update if any changes are required in future
- Any and all columns added to the HTML template will be exported to Excel - no extra step that could be missed
- Once a few example reports are built this way, the pattern will be copied - so our default would be building HTML report templates that are easily parsed to Excel

_Cons:_

- When building a primarily HTML report, it may be constraining to have to think in tables. Header sections might not make much sense to reason about as a "table" when thinking in HTML.
- Unclear development workflow for building a primarily Excel report - you have to build an HTML template that can be mapped into the Excel report you want
- If complex headers/tables have complex formatting, a lot of formatting/styling would need to parsed by the OMS core, from the HTML template to be mapped to Excel - dev overhead and potential code bloat, and would be hard to know where to look for what styles are supported when defining new reports in the reports repo.
- Would be difficult/impossible to expose any formulae in the Excel report

### Option 2 - HTML Attributes

We keep the existing HTML template, adding custom attributes to the HTML elements, where the data inside them should be rendered in a particular Excel column/cell.

E.g. `<div excel-cell="B7">Supplier name</div>` would render `Supplier name` in the cell `B7`.

_Pros:_

- More targetted control of where data will be rendered when exported to Excel
- Elements can be added only to the HTML template, but not mapped to the Excel template where it doesn't make sense

_Cons:_

- Requires an extra step for developers: build the HTML report, then go through and append which columns should go where when exported to Excel
- Making changes to the HTML template, it could be easy to forget the Excel
- Styles/formatting would need to parsed and applied separately - we'd probably only support a subset, or would result in bloat
- Difficult/impossible to map the formulae to Excel columns

### Option 3 - HTML Attributes + optional Excel template

HTML template is required, with HTML attributes defining where data should go. However, can also include an Excel template in the report configuration - when present, use this instead of a blank Excel worksheet.

_Pros:_

- Formatting/styling of the Excel report is the responsibility of the template, we don't need to map this when converting
- Can just populate base fields, and leave calculated columns to use the pre-populated formulae
- Fastest way to implement complex Excel reports, while also building an HTML version to allow them to be printable

_Cons:_

- Two templates to maintain - if HTML says `B7` but the Excel template has been updated, it should be in `C7`, data in the wrong place can be very misleading
  - Something should exist in the development workflow to encourage developer to always check both formats

## Decision

Keep existing generate-from-html capability - anything defined in an HTML table will automatically be mapped to Excel. This is the lowest effort solution for existing reports and primarily HTML/printed reports.

But this process should first query the HTML template for the Excel attributes, and if they exist, instead use option 3. Populate a template Excel file if provided, otherwise create a blank one and populate from there. Assume no styling in the Excel sheet (beyond data table headers being bold, and maybe the report title) - if styles are required, an Excel template should be provided.

### Consequences

- We're supporting a number of use cases, it needs to be clearly documented when to take which approach.
